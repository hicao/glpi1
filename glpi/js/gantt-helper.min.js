var GlpiGantt=function(){var t=false;var e=CFG_GLPI.root_doc+"/ajax/gantt.php";var a="%Y-%m-%d %H:%i";var n=CFG_GLPI.gantt_date_format;var r=gantt.date.date_to_str(a);return{init:function(r){var x=[{key:gantt.config.types.project,label:_n("Project","Projects",1)},{key:gantt.config.types.task,label:_n("Task","Tasks",1)},{key:gantt.config.types.milestone,label:__("Milestone")}];var v=[{key:gantt.config.types.task,label:_n("Task","Tasks",1)},{key:gantt.config.types.milestone,label:__("Milestone")}];var b=[{name:"description",height:70,map_to:"text",type:"textarea",focus:true,default_value:__("New project")},{name:"time",type:"duration",map_to:"auto"}];var T=[{name:"description",height:70,map_to:"text",type:"textarea",focus:true,default_value:__("New project")},{name:"time",type:"duration",map_to:"auto"},{name:"type",type:"radio",map_to:"type",options:x,default_value:gantt.config.types.project}];var j=[{name:"description",height:70,map_to:"text",type:"textarea",focus:true},{name:"time",type:"duration",map_to:"auto"},{name:"type",type:"radio",map_to:"type",options:v,default_value:gantt.config.types.task}];var L="";var w;gantt.config.grid_width=600;gantt.config.grid_resize=true;gantt.config.date_format=a;gantt.config.date_grid=n;gantt.config.order_branch="marker";gantt.config.order_branch_free=true;gantt.config.show_progress=true;gantt.config.sort=true;if(window.innerWidth<600){gantt.config.show_grid=false}gantt.config.lightbox.project_sections=[{name:"description",height:70,map_to:"text",type:"textarea",focus:true}];gantt.config.lightbox.sections=[{name:"description",height:70,map_to:"text",type:"textarea",focus:true},{name:"time",type:"duration",map_to:"auto"}];gantt.config.lightbox.milestone_sections=[{name:"description",height:70,map_to:"text",type:"textarea",focus:true},{name:"time",type:"duration",single_date:true,map_to:"auto"}];gantt.templates.task_class=function(t,e,a){var n=[];if(a.type=="project"){n.push("no_progress_drag");n.push("no_link_drag")}return n.join(" ")};gantt.templates.rightside_text=function(t,e,a){if(a.type==gantt.config.types.milestone){return a.text}return""};gantt.templates.progress_text=function(t,e,a){return"<span style='text-align:left; color: #fff;'>"+Math.round(a.progress*100)+"% </span>"};gantt.plugins({tooltip:true,fullscreen:true,undo:true});gantt.templates.tooltip_text=function(t,e,a){var n='<b><span class="capitalize">'+a.type+":</span></b> "+a.text+"<br/><b>"+__("Start date:")+"</b> "+gantt.templates.tooltip_date_format(t)+"<br/><b>"+__("End date:")+"</b> "+gantt.templates.tooltip_date_format(e)+"<br/><b>"+__("Progress:")+"</b> "+parseInt(a.progress*100)+"%";if(a.content&&a.content.length>0){n+="<br/><b>"+__("Description:")+'</b><div style="padding-left:25px">'+a.content+"</div>"}if(a.comment&&a.comment.length>0){n+="<br/><b>"+__("Comment:")+'</b><div style="padding-left:25px">'+a.comment+"</div>"}return n};gantt.config.columns=[{name:"text",label:__("Project / Task"),width:290,tree:true,align:"left"},{name:"start_date",label:__("Start date"),align:"left",width:90},{name:"duration",label:__("Duration"),align:"center",width:47},{name:"add",align:"center"}];gantt.ext.fullscreen.getFullscreenElement=function(){return document.getElementById("gantt-container")};var S={levels:[{name:"day",scale_height:27,min_column_width:80,scales:[{unit:"day",step:1,format:"%d %M"}]},{name:"week",scale_height:50,min_column_width:50,scales:[{unit:"week",step:1,format:function(t){var e=gantt.date.date_to_str("%d %M");var a=gantt.date.add(t,6,"day");var n=gantt.date.date_to_str("%W")(t);return"#"+n+", "+e(t)+" - "+e(a)}},{unit:"day",step:1,format:"%j %D"}]},{name:"month",scale_height:50,min_column_width:120,scales:[{unit:"month",format:"%F, %Y"},{unit:"week",format:__("Week #%s").replace("%s","%W")}]},{name:"quarter",height:50,min_column_width:90,scales:[{unit:"month",step:1,format:"%M"},{unit:"quarter",step:1,format:function(t){var e=gantt.date.date_to_str("%M");var a=gantt.date.add(gantt.date.add(t,3,"month"),-1,"day");return e(t)+" - "+e(a)}}]},{name:"year",scale_height:50,min_column_width:30,scales:[{unit:"year",step:1,format:"%Y"}]}]};gantt.ext.zoom.init(S);gantt.ext.zoom.setLevel("month");gantt.ext.zoom.attachEvent("onAfterZoom",(function(t,e){document.querySelector(".gantt_radio[value='"+e.name+"']").checked=true}));$("input[name='scale']").on("click",(function(t){gantt.ext.zoom.setLevel(t.target.value)}));gantt.attachEvent("onBeforeRowDragMove",(function(t){$("#hf_gantt_item_state").val(t+"|"+gantt.getTask(t).parent)}));gantt.attachEvent("onBeforeRowDragEnd",(function(t,e){var a=gantt.getTask(t);var n=null;var r=true;if(e==0){if(a.type==gantt.config.types.project&&a.parent!=e){a.parent=e;u(a)}else{r=false}}else{n=gantt.getTask(e);if(a.type==gantt.config.types.project&&n.type!=gantt.config.types.project||a.parent==e){r=false}else{d(a,n)}}return r}));if(!t){gantt.attachEvent("onAfterTaskDrag",(function(t){var e=gantt.getTask(t);var a=Math.round(e.progress*100/5)*5/100;l(t,e,a)}));gantt.attachEvent("onAfterTaskUpdate",(function(t){s(t)}));gantt.attachEvent("onTaskDblClick",(function(t){m(gantt.getTask(t))}));gantt.attachEvent("onBeforeLightbox",(function(t){var e=gantt.getTask(t);if(e.$new){if(e.parent&&!isNaN(e.parent)){gantt.config.lightbox.sections=T}else if(isNaN(e.parent)){gantt.config.lightbox.sections=j}else{gantt.config.lightbox.sections=b}gantt.config.buttons_right=[];gantt.resetLightbox()}return true}));gantt.attachEvent("onLightbox",(function(t){var e=gantt.getTask(t);if(e.$new){gantt.getLightboxSection("time").setValue(new Date);if(!isNaN(e.parent)){gantt.getLightboxSection("description").setValue(__("New project"))}}else{if(gantt.getLightboxSection("type")){gantt.getLightboxSection("type").setValue(e.type)}}}));gantt.attachEvent("onLightboxSave",(function(t,e,a){if(a){if(e.parent==0||gantt.getLightboxSection("type")&&gantt.getLightboxSection("type").getValue()==gantt.config.types.project){f(t,e)}else{g(t,e)}}else if(e.type=="project"){p(t,e)}else{c(t,e)}return false}));gantt.attachEvent("onBeforeLinkAdd",(function(t,e){var a=gantt.getTask(e.source);var n=gantt.getTask(e.target);if(i(a,n,e.type)){_(t,a,n,e)}else return false}));(function(){var t;var e;gantt.attachEvent("onLinkDblClick",(function(a){e=a;var o=gantt.getLink(a);var i;switch(parseInt(o.type)){case parseInt(gantt.config.links.finish_to_start):i=__("Finish to Start: ");break;case parseInt(gantt.config.links.finish_to_finish):i=__("Finish to Finish: ");break;case parseInt(gantt.config.links.start_to_start):i=__("Start to Start: ");break;case parseInt(gantt.config.links.start_to_finish):i=__("Start to Finish: ");break}i+=" "+gantt.getTask(o.source).text+" -> "+gantt.getTask(o.target).text;t=gantt.modalbox({title:`<p class="gantt_cal_lsection" style="line-height:normal">${i}</p>`,text:`<div class="gantt_cal_lsection">\n                     <label>${__("Lag")} <input type="number" class="lag-input" /></label>\n                     </div>`,buttons:[{label:__("Save"),css:"gantt_save_btn",value:"save"},{label:__("Cancel"),css:"gantt_cancel_btn",value:"cancel"},{label:__("Delete"),css:"gantt_delete_btn",value:"delete"}],width:"500px",callback:function(t){switch(t){case"save":s();break;case"cancel":n();break;case"delete":r();break}}});t.querySelector(".lag-input").value=o.lag||0;return false}));function a(){t=null;e=null}function n(){a()}function r(){h(e,a)}function s(){var n=gantt.getLink(e);var r=t.querySelector(".lag-input").value;if(!isNaN(parseInt(r,10))){n.lag=parseInt(r,10)}k(n,a)}})()}gantt.attachEvent("onBeforeExpand",(function(){$(".gantt-block__features").css({position:"absolute",bottom:"18px",right:"10px"});return true}));gantt.attachEvent("onCollapse",(function(){$(".gantt-block__features").css({position:"initial",bottom:"10px"});return true}));gantt.templates.grid_row_class=function(t,e,a){if(!L||!$("#rb-find").is(":checked")){return""}var n=a.text.toLowerCase();var r=L.toLowerCase();return n.indexOf(r)>-1?"highlight":""};gantt.attachEvent("onBeforeTaskDisplay",(function(t,e){if(!L||!$("#rb-filter").is(":checked")){return true}var a=e.text.toLowerCase();var n=L.toLowerCase();return a.indexOf(n)>-1}));$(".gantt_radio[name=rb-optype]").on("change",(function(){gantt.render()}));gantt.attachEvent("onGanttRender",(function(){$("#search").val(L)}));gantt.$doFilter=function(t){L=t;clearTimeout(w);w=setTimeout((function(){gantt.render();$("#search").focus()}),500)};gantt.config.readonly=t;gantt.init("gantt-container");$.ajax({url:e,type:"POST",data:{getData:1,id:r},success:function(e){if(e.data){gantt.parse(e);gantt.render();if(t){gantt.message.position="bottom";gantt.message({type:"warning",text:__("Gantt mode: 'Readonly'"),expire:-1})}y(1);o();gantt.sort("text",false)}else{gantt.alert(e.error)}},error:function(t){gantt.alert(t.responseText)}})}};function s(t){gantt.eachParent((function(t){var e=gantt.getChildren(t.id);var a=0;for(var n=0;n<e.length;n++){var r=gantt.getTask(e[n]);a+=r.progress*100}t.progress=a/e.length/100}),t);gantt.render()}function o(){gantt.eachTask((function(t){if(t.progress>0){s(t.id)}}))}function i(t,e,a){var n=true;if(t.type=="project"&&e.type=="project"){gantt.alert(__("Links between projects cannot be created."));n=false}else if(t.type=="project"||e.type=="project"){gantt.alert(__("Links between projects and tasks cannot be created."));n=false}else if(a==gantt.config.links.finish_to_start&&e.start_date<t.end_date){gantt.alert(__("Target task can't start before source task ends."));n=false}else if(a==gantt.config.links.start_to_start&&e.start_date<t.start_date){gantt.alert(__("Target task can't start before source task starts."));n=false}else if(a==gantt.config.links.finish_to_finish&&e.end_date<t.end_date){gantt.alert(__("Target task can't end before source task ends."));n=false}else if(a==gantt.config.links.start_to_finish&&e.end_date<t.start_date){gantt.alert(__("Target task can't end before the source task starts."));n=false}return n}function g(t,a){$.ajax({url:e,type:"POST",async:false,data:{addTask:1,task:{parent:a.parent,name:a.text,type:a.type,start_date:r(a.start_date),end_date:r(a.end_date)}},success:function(e){if(e.ok){gantt.addTask(e.item);gantt.hideLightbox();gantt.deleteTask(t);displayAjaxMessageAfterRedirect()}else{gantt.alert(__("Could not create task: ")+e.error)}},error:function(t){gantt.alert(t.responseText)}})}function c(t,a){$.ajax({url:e,type:"POST",data:{updateTask:1,task:{id:a.linktask_id,name:a.text,type:a.type,start_date:r(a.start_date),end_date:r(a.end_date)}},success:function(e){if(e.ok){var n=gantt.getTask(t);n.text=a.text;n.type=a.type;n.start_date=a.start_date;n.end_date=a.end_date;gantt.updateTask(t);gantt.hideLightbox();displayAjaxMessageAfterRedirect()}else gantt.alert(__("Could not update Task[%s]: ").replace("%s",a.text)+e.error)},error:function(t){gantt.alert(t.responseText)}})}function l(t,a,n){$.ajax({url:e,type:"POST",data:{updateTask:1,task:{id:a.linktask_id,start_date:r(a.start_date),end_date:r(a.end_date),progress:n}},success:function(t){if(t.ok){a.progress=n;gantt.updateTask(a.id);displayAjaxMessageAfterRedirect()}else{gantt.alert(__("Could not update Task[%s]: ").replace("%s",a.text)+t.error);gantt.undo()}}})}function d(t,a){$.ajax({url:e,type:"POST",data:{changeItemParent:1,item:t,target:a},success:function(e){if(!e.ok){gantt.alert(e.error);t.parent=$("#hf_gantt_item_state").val().split("|")[1];$("#hf_gantt_item_state").val("");gantt.updateTask(t.id);gantt.render()}else{if(t.progress>0){s(t.id)}displayAjaxMessageAfterRedirect()}},error:function(t){gantt.alert(t.responseText)}})}function u(t){$.ajax({url:e,type:"POST",data:{makeRootProject:1,item:t},success:function(e){if(!e.ok){gantt.alert(e.error);t.parent=$("#hf_gantt_item_state").val().split("|")[1];$("#hf_gantt_item_state").val("");gantt.updateTask(t.id);gantt.render()}else{if(t.progress>0){s(t.id)}displayAjaxMessageAfterRedirect()}},error:function(t){gantt.alert(t.responseText)}})}function f(t,a){$.ajax({url:e,type:"POST",async:false,data:{addProject:1,project:{parent:a.parent,name:a.text,start_date:r(a.start_date),end_date:r(a.end_date)}},success:function(e){if(e.ok){gantt.addTask(e.item);gantt.hideLightbox();gantt.deleteTask(t);displayAjaxMessageAfterRedirect()}else{gantt.alert(__("Could not create project: ")+e.error)}},error:function(t){gantt.alert(t.responseText)}})}function p(t,a){$.ajax({url:e,type:"POST",data:{updateProject:1,project:{id:a.id,name:a.text}},success:function(e){if(e.ok){var n=gantt.getTask(t);n.text=a.text;gantt.updateTask(t);gantt.hideLightbox();displayAjaxMessageAfterRedirect()}else{gantt.alert(__("Could not update Project[%s]: ").replace("%s",a.text)+e.error)}},error:function(t){gantt.alert(t.responseText)}})}function _(t,a,n,r){$.ajax({url:e,type:"POST",data:{addTaskLink:1,taskLink:{projecttasks_id_source:a.linktask_id,source_uuid:a.id,projecttasks_id_target:n.linktask_id,target_uuid:n.id,type:r.type,lag:r.lag,lead:r.lead}},success:function(e){if(e.ok){var a=r.id;gantt.changeLinkId(a,e.id)}else{gantt.alert(e.error);gantt.deleteLink(t)}},error:function(e){gantt.alert(e.responseText);gantt.deleteLink(t)}})}function k(t,a){$.ajax({url:e,type:"POST",data:{updateTaskLink:1,taskLink:{id:t.id,lag:t.lag}},success:function(t){if(t.ok){a()}else{gantt.alert(t.error)}},error:function(t){gantt.alert(t.responseText)}})}function h(t,a){$.ajax({url:e,type:"POST",data:{deleteTaskLink:1,id:t},success:function(e){if(e.ok){gantt.deleteLink(t);a()}else{gantt.alert(e.error)}},error:function(t){gantt.alert(t.responseText)}})}function m(t){$.ajax({url:e,type:"POST",data:{openEditForm:1,item:t},success:function(t){if(t.ok){window.location=t.url}else{gantt.alert(t.error)}},error:function(t){gantt.alert(t.responseText)}})}function y(t){var e=$("#collapse").is(":checked");gantt.eachTask((function(a){var n=gantt.calculateTaskLevel(a);a.$open=false;if(e){a.$open=n<t&&a.type==gantt.config.types.project}else{a.$open=n<=t&&a.type==gantt.config.types.project}}));gantt.render()}}();